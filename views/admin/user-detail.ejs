<%- include('../components/head') %>

<body class="min-h-screen bg-neutral-950 text-slate-100">
  <div>
    <%- include('../components/adminnav') %>
    <div class="md:pl-64 flex flex-col flex-1 min-h-screen">
      <%- include('../components/header') %>
      <main class="flex-1 pb-8">
        <div class="py-4 md:py-6">
          <% /* Skeleton loader, lasts about 0.3s to let the page content load */ %>
          <%- include('../components/skeleton') %>
          <div class="hidden max-w-screen-2xl mx-auto px-4 sm:px-6 md:px-8" id="content">
            <div class="bg-neutral-900 rounded-sm md:rounded-sm p-4 md:p-6 mb-6 border-t border-neutral-800/70 shadow-sm">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="mb-3 md:mb-0">
                  <h2 class="text-lg md:text-xl font-semibold text-white tracking-tight">User Details</h2>
                  <p class="text-xs md:text-sm font-normal text-slate-400 mt-1">Manage panel and local account settings for <%= pteroUser.username %>.</p>
                </div>
                <div class="flex space-x-3">
                  <a href="/admin/user" class="inline-flex items-center justify-center rounded-full border border-neutral-800 bg-white/5 px-4 py-2 text-sm font-medium text-white hover:bg-white/10 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" />
                    </svg>
                    Back to Users
                  </a>
                </div>
              </div>
            </div>

            <% if (req.query.err) { %>
            <div class="rounded-sm md:rounded-sm border border-neutral-800/70 p-4 mb-6 bg-red-500/10">
              <div class="flex">
                <div class="flex-shrink-0">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                  </svg>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-white">Error code: <code class="bg-white/10 px-1.5 py-0.5 rounded-sm"><%= req.query.err %></code></p>
                </div>
              </div>
            </div>
            <% } %>

            <% if (req.query.success) { %>
            <div class="rounded-sm md:rounded-sm border border-neutral-800/70 p-4 mb-6 bg-sky-500/10">
              <div class="flex">
                <div class="flex-shrink-0">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-sky-500" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                  </svg>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-white"><%= req.query.success %></p>
                </div>
              </div>
            </div>
            <% } %>

            <% if (req.query.password) { %>
            <div class="rounded-sm md:rounded-sm border border-neutral-800/70 p-4 mb-6 bg-neutral-900/80">
              <p class="text-sm text-slate-300">Temporary password: <code class="bg-white/10 px-1.5 py-0.5 rounded-sm"><%= req.query.password %></code></p>
            </div>
            <% } %>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div class="lg:col-span-1 space-y-6">
                <div class="bg-neutral-900/60 rounded-sm p-5 border-t border-neutral-800/70 shadow-sm">
                  <h3 class="text-base font-semibold text-white">Panel Overview</h3>
                  <div class="mt-4 space-y-2 text-sm">
                    <div class="flex items-center justify-between">
                      <span class="text-slate-400">Panel ID</span>
                      <span class="text-white"><%= pteroUser.id %></span>
                    </div>
                    <div class="flex items-center justify-between">
                      <span class="text-slate-400">Username</span>
                      <span class="text-white"><%= pteroUser.username %></span>
                    </div>
                    <div class="flex items-center justify-between">
                      <span class="text-slate-400">Email</span>
                      <span class="text-white"><%= pteroUser.email %></span>
                    </div>
                    <div class="flex items-center justify-between">
                      <span class="text-slate-400">Name</span>
                      <span class="text-white"><%= pteroUser.first_name %> <%= pteroUser.last_name %></span>
                    </div>
                    <div class="flex items-center justify-between">
                      <span class="text-slate-400">Root Admin</span>
                      <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium <%= pteroUser.root_admin ? 'bg-purple-500/20 text-purple-300' : 'bg-sky-500/10 text-sky-500' %>"><%= pteroUser.root_admin ? 'Admin' : 'User' %></span>
                    </div>
                    <div class="flex items-center justify-between">
                      <span class="text-slate-400">Language</span>
                      <span class="text-white"><%= pteroUser.language %></span>
                    </div>
                    <div class="flex items-center justify-between">
                      <span class="text-slate-400">Servers</span>
                      <span class="text-white"><%= userServers.length %></span>
                    </div>
                  </div>
                </div>

                <div class="bg-neutral-900/60 rounded-sm p-5 border-t border-neutral-800/70 shadow-sm">
                  <h3 class="text-base font-semibold text-white">Danger Zone</h3>
                  <p class="text-xs text-slate-400 mt-1">Panel deletion is permanent.</p>
                  <div class="mt-4">
                    <button type="button" class="w-full px-4 py-2 rounded-sm bg-red-600 text-sm font-medium text-white hover:bg-red-700" onclick="deleteUser()">Delete Panel User</button>
                  </div>
                </div>
              </div>

              <div class="lg:col-span-2 space-y-6">
                <div class="bg-neutral-900/60 rounded-sm p-5 border-t border-neutral-800/70 shadow-sm">
                  <h3 class="text-base font-semibold text-white">Update Profile</h3>
                  <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                      <label class="block text-xs font-medium text-slate-400 mb-2" for="edit_username">Username</label>
                      <input id="edit_username" type="text" class="w-full rounded-sm border border-neutral-800/70 bg-neutral-900/60 px-3 py-2 text-sm text-white" value="<%= pteroUser.username %>">
                    </div>
                    <div>
                      <label class="block text-xs font-medium text-slate-400 mb-2" for="edit_email">Email</label>
                      <input id="edit_email" type="email" class="w-full rounded-sm border border-neutral-800/70 bg-neutral-900/60 px-3 py-2 text-sm text-white" value="<%= pteroUser.email %>">
                    </div>
                    <div>
                      <label class="block text-xs font-medium text-slate-400 mb-2" for="edit_first_name">First Name</label>
                      <input id="edit_first_name" type="text" class="w-full rounded-sm border border-neutral-800/70 bg-neutral-900/60 px-3 py-2 text-sm text-white" value="<%= pteroUser.first_name %>">
                    </div>
                    <div>
                      <label class="block text-xs font-medium text-slate-400 mb-2" for="edit_last_name">Last Name</label>
                      <input id="edit_last_name" type="text" class="w-full rounded-sm border border-neutral-800/70 bg-neutral-900/60 px-3 py-2 text-sm text-white" value="<%= pteroUser.last_name %>">
                    </div>
                    <div>
                      <label class="block text-xs font-medium text-slate-400 mb-2" for="edit_language">Language</label>
                      <input id="edit_language" type="text" class="w-full rounded-sm border border-neutral-800/70 bg-neutral-900/60 px-3 py-2 text-sm text-white" value="<%= pteroUser.language %>">
                    </div>
                    <div class="flex items-center gap-2 mt-6">
                      <input id="edit_root_admin" type="checkbox" class="h-4 w-4 rounded border-neutral-700 bg-neutral-950 text-sky-500" <%= pteroUser.root_admin ? 'checked' : '' %>>
                      <label for="edit_root_admin" class="text-sm text-slate-300">Root admin</label>
                    </div>
                  </div>
                  <div class="mt-4 flex justify-end">
                    <button type="button" class="px-4 py-2 rounded-sm bg-sky-500 text-sm font-medium text-white hover:bg-sky-400" onclick="updateUser()">Save Changes</button>
                  </div>
                </div>

                <div class="bg-neutral-900/60 rounded-sm p-5 border-t border-neutral-800/70 shadow-sm">
                  <h3 class="text-base font-semibold text-white">Reset Password</h3>
                  <p class="text-xs text-slate-400 mt-1">Leave blank to auto-generate a password.</p>
                  <div class="mt-4 flex flex-col sm:flex-row gap-3">
                    <input id="reset_password" type="text" class="flex-1 rounded-sm border border-neutral-800/70 bg-neutral-900/60 px-3 py-2 text-sm text-white" placeholder="New password">
                    <button type="button" class="px-4 py-2 rounded-sm bg-white/5 text-sm font-medium text-white hover:bg-white/10" onclick="resetPassword()">Reset</button>
                  </div>
                </div>

                <div class="bg-neutral-900/60 rounded-sm p-5 border-t border-neutral-800/70 shadow-sm">
                  <h3 class="text-base font-semibold text-white">Local Account</h3>
                  <p class="text-xs text-slate-400 mt-1">Link Discord ID to manage coins, plans, and extra resources.</p>
                  <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                      <label class="block text-xs font-medium text-slate-400 mb-2" for="discord_link">Discord ID</label>
                      <input id="discord_link" type="text" class="w-full rounded-sm border border-neutral-800/70 bg-neutral-900/60 px-3 py-2 text-sm text-white" value="<%= linkedDiscordId %>" placeholder="123456789012345678">
                    </div>
                    <div class="flex items-end">
                      <button type="button" class="w-full px-4 py-2 rounded-sm bg-white/5 text-sm font-medium text-white hover:bg-white/10" onclick="linkDiscord()">Link / Refresh</button>
                    </div>
                  </div>

                  <% if (localData) { %>
                  <div class="mt-4 border-t border-neutral-800/70 pt-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                      <div class="flex items-center justify-between">
                        <span class="text-slate-400">Plan</span>
                        <span class="text-white"><%= localData.packageName %></span>
                      </div>
                      <div class="flex items-center justify-between">
                        <span class="text-slate-400">Coins</span>
                        <span class="text-white"><%= localData.coins %></span>
                      </div>
                      <div class="flex items-center justify-between">
                        <span class="text-slate-400">Extra RAM</span>
                        <span class="text-white"><%= localData.extra.ram %></span>
                      </div>
                      <div class="flex items-center justify-between">
                        <span class="text-slate-400">Extra Disk</span>
                        <span class="text-white"><%= localData.extra.disk %></span>
                      </div>
                      <div class="flex items-center justify-between">
                        <span class="text-slate-400">Extra CPU</span>
                        <span class="text-white"><%= localData.extra.cpu %></span>
                      </div>
                      <div class="flex items-center justify-between">
                        <span class="text-slate-400">Extra Servers</span>
                        <span class="text-white"><%= localData.extra.servers %></span>
                      </div>
                      <div class="flex items-center justify-between">
                        <span class="text-slate-400">Last IP</span>
                        <span class="text-white"><%= localData.ip || 'Not stored' %></span>
                      </div>
                    </div>
                  </div>
                  <% } %>

                  <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="bg-neutral-950/60 rounded-sm border border-neutral-800/70 p-4">
                      <h4 class="text-sm font-semibold text-white mb-3">Set Plan</h4>
                      <select id="plan_select" class="w-full rounded-sm border border-neutral-800/70 bg-neutral-900/60 px-3 py-2 text-sm text-white">
                        <option value="">Default plan</option>
                        <% Object.keys(packageList || {}).forEach((pkg) => { %>
                          <option value="<%= pkg %>" <%= localData && localData.packageName === pkg ? 'selected' : '' %>><%= pkg %></option>
                        <% }) %>
                      </select>
                      <button type="button" class="mt-3 w-full px-4 py-2 rounded-sm bg-white/5 text-sm font-medium text-white hover:bg-white/10" onclick="setPlan()">Apply Plan</button>
                    </div>
                    <div class="bg-neutral-950/60 rounded-sm border border-neutral-800/70 p-4">
                      <h4 class="text-sm font-semibold text-white mb-3">Set Coins</h4>
                      <input id="coins_set" type="number" class="w-full rounded-sm border border-neutral-800/70 bg-neutral-900/60 px-3 py-2 text-sm text-white" placeholder="0">
                      <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button type="button" class="w-full px-4 py-2 rounded-sm bg-white/5 text-sm font-medium text-white hover:bg-white/10" onclick="setCoins()">Set</button>
                        <button type="button" class="w-full px-4 py-2 rounded-sm bg-white/5 text-sm font-medium text-white hover:bg-white/10" onclick="addCoins()">Add/Remove</button>
                      </div>
                    </div>
                  </div>

                  <div class="mt-4 bg-neutral-950/60 rounded-sm border border-neutral-800/70 p-4">
                    <h4 class="text-sm font-semibold text-white mb-3">Adjust Resources</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                      <input id="res_ram" type="number" class="w-full rounded-sm border border-neutral-800/70 bg-neutral-900/60 px-3 py-2 text-sm text-white" placeholder="RAM">
                      <input id="res_disk" type="number" class="w-full rounded-sm border border-neutral-800/70 bg-neutral-900/60 px-3 py-2 text-sm text-white" placeholder="Disk">
                      <input id="res_cpu" type="number" class="w-full rounded-sm border border-neutral-800/70 bg-neutral-900/60 px-3 py-2 text-sm text-white" placeholder="CPU">
                      <input id="res_servers" type="number" class="w-full rounded-sm border border-neutral-800/70 bg-neutral-900/60 px-3 py-2 text-sm text-white" placeholder="Servers">
                    </div>
                    <p class="text-xs text-slate-500 mt-2">Use positive or negative values to add or remove extras.</p>
                    <button type="button" class="mt-3 w-full px-4 py-2 rounded-sm bg-white/5 text-sm font-medium text-white hover:bg-white/10" onclick="setResources()">Apply Changes</button>
                  </div>

                  <% if (localData) { %>
                  <div class="mt-4">
                    <button type="button" class="w-full px-4 py-2 rounded-sm bg-red-600 text-sm font-medium text-white hover:bg-red-700" onclick="removeLocal()">Remove Local Account Data</button>
                  </div>
                  <% } %>
                </div>

                <% if (userServers && userServers.length) { %>
                <div class="bg-neutral-900/60 rounded-sm p-5 border-t border-neutral-800/70 shadow-sm">
                  <h3 class="text-base font-semibold text-white">Servers</h3>
                  <div class="mt-3 overflow-auto">
                    <table class="min-w-full divide-y divide-white/5 text-sm">
                      <thead class="bg-white/5">
                        <tr>
                          <th class="px-4 py-2 text-left text-xs font-medium text-slate-400 uppercase">Name</th>
                          <th class="px-4 py-2 text-left text-xs font-medium text-slate-400 uppercase">ID</th>
                          <th class="px-4 py-2 text-left text-xs font-medium text-slate-400 uppercase">Actions</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-white/5">
                        <% userServers.forEach((server) => { %>
                          <tr>
                            <td class="px-4 py-2 text-slate-200"><%= server.attributes.name %></td>
                            <td class="px-4 py-2 text-slate-400"><%= server.attributes.id %></td>
                            <td class="px-4 py-2">
                              <a class="text-sky-400 hover:text-sky-300" href="/admin/server/<%= server.attributes.id %>/edit">Edit</a>
                            </td>
                          </tr>
                        <% }) %>
                      </tbody>
                    </table>
                  </div>
                </div>
                <% } %>
              </div>
            </div>
          </div>
        </div>
      </main>
      <%- include('../components/footer') %>
      <%- include('../components/notifications') %>
    </div>
  </div>

  <script>
    function buildQuery(params) {
      const search = new URLSearchParams();
      Object.entries(params).forEach(([key, value]) => {
        if (value !== "" && value !== null && typeof value !== "undefined") {
          search.append(key, value);
        }
      });
      return search.toString();
    }

    function updateUser() {
      const params = {
        username: document.getElementById("edit_username").value.trim(),
        email: document.getElementById("edit_email").value.trim(),
        first_name: document.getElementById("edit_first_name").value.trim(),
        last_name: document.getElementById("edit_last_name").value.trim(),
        language: document.getElementById("edit_language").value.trim(),
        root_admin: document.getElementById("edit_root_admin").checked
      };
      window.location.href = `/admin/user/<%= pteroUser.id %>/update?${buildQuery(params)}`;
    }

    function resetPassword() {
      const password = document.getElementById("reset_password").value.trim();
      window.location.href = `/admin/user/<%= pteroUser.id %>/reset-password?${buildQuery({ password })}`;
    }

    function linkDiscord() {
      const discord = document.getElementById("discord_link").value.trim();
      if (!discord) {
        showNotification("Please enter a Discord ID to link.", "error");
        return;
      }
      window.location.href = `/admin/user/<%= pteroUser.id %>/link?${buildQuery({ discord })}`;
    }

    function setPlan() {
      const discord = document.getElementById("discord_link").value.trim();
      const pkg = document.getElementById("plan_select").value;
      if (!discord) {
        showNotification("Link a Discord ID first.", "error");
        return;
      }
      window.location.href = `/admin/user/<%= pteroUser.id %>/local/plan?${buildQuery({ discord: discord, package: pkg })}`;
    }

    function setCoins() {
      const discord = document.getElementById("discord_link").value.trim();
      const coins = document.getElementById("coins_set").value.trim();
      if (!discord) {
        showNotification("Link a Discord ID first.", "error");
        return;
      }
      window.location.href = `/admin/user/<%= pteroUser.id %>/local/coins?${buildQuery({ discord: discord, coins: coins, mode: "set" })}`;
    }

    function addCoins() {
      const discord = document.getElementById("discord_link").value.trim();
      const coins = document.getElementById("coins_set").value.trim();
      if (!discord) {
        showNotification("Link a Discord ID first.", "error");
        return;
      }
      window.location.href = `/admin/user/<%= pteroUser.id %>/local/coins?${buildQuery({ discord: discord, coins: coins, mode: "add" })}`;
    }

    function setResources() {
      const discord = document.getElementById("discord_link").value.trim();
      if (!discord) {
        showNotification("Link a Discord ID first.", "error");
        return;
      }
      const params = {
        discord: discord,
        ram: document.getElementById("res_ram").value.trim(),
        disk: document.getElementById("res_disk").value.trim(),
        cpu: document.getElementById("res_cpu").value.trim(),
        servers: document.getElementById("res_servers").value.trim()
      };
      window.location.href = `/admin/user/<%= pteroUser.id %>/local/resources?${buildQuery(params)}`;
    }

    function removeLocal() {
      const discord = document.getElementById("discord_link").value.trim();
      if (!discord) {
        showNotification("Link a Discord ID first.", "error");
        return;
      }
      if (!confirm("Remove local account data? This does not delete the panel user.")) {
        return;
      }
      window.location.href = `/remove_account?${buildQuery({ id: discord })}`;
    }

    function deleteUser() {
      if (!confirm("Delete this panel user? This cannot be undone.")) {
        return;
      }
      const discord = document.getElementById("discord_link").value.trim();
      const query = discord ? `?discord=${encodeURIComponent(discord)}` : "";
      window.location.href = `/admin/user/<%= pteroUser.id %>/delete${query}`;
    }
  </script>
</body>
