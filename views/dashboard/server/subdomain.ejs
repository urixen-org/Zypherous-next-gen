<%- include('../../components/head') %>

<body class="min-h-screen bg-neutral-950 text-slate-100">
  <%- include('../../components/modal') %>
  <div>
    <%- include('../../components/navigation') %>
    <div class="md:pl-64 flex flex-col flex-1 min-h-screen">
      <%- include('../../components/header') %>
      <main class="flex-1 pb-8">
        <div class="py-4 md:py-6">
          <%- include('../../components/skeleton') %>
          <div class="hidden max-w-screen-2xl mx-auto px-4 sm:px-6 md:px-8" id="content">
            <%- include('./header') %>
            <%- include('./tabs') %>

            <%
              const firstAllocation = server.relationships && server.relationships.allocations && server.relationships.allocations.data && server.relationships.allocations.data.length
                ? server.relationships.allocations.data[0].attributes
                : null;
              const defaultIp = firstAllocation ? (firstAllocation.ip_alias || firstAllocation.ip) : "0.0.0.0";
              const defaultPort = firstAllocation ? firstAllocation.port : 25565;
              let panelHost = "example.com";
              try {
                const parsed = new URL(settings.pterodactyl.domain);
                panelHost = parsed.hostname || "example.com";
              } catch (err) {
                panelHost = "example.com";
              }
            %>

            <div class="grid grid-cols-1 xl:grid-cols-[1.6fr_1fr] gap-6 mt-6">
              <div class="bg-neutral-900/60 border border-neutral-800/80 rounded-2xl p-6 space-y-4">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Subdomain creator</p>
                    <h2 class="text-xl font-semibold text-white mt-1">Point a friendly name at your server</h2>
                    <p class="text-sm text-slate-400 mt-1">Generate DNS records you can paste into your registrar or hand off to staff.</p>
                  </div>
                  <div class="rounded-full bg-white/5 border border-neutral-800 px-3 py-1 text-xs text-slate-300">
                    Works with Cloudflare, Namecheap, Route53, and more.
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <label class="block text-xs uppercase tracking-[0.3em] text-slate-500">
                    Subdomain prefix
                    <input
                      id="subdomain-prefix"
                      type="text"
                      value="play"
                      class="mt-1 w-full rounded-xl border border-neutral-800 bg-neutral-950 py-2 px-3 text-sm text-white focus:border-sky-500 focus:outline-none"
                      placeholder="play"
                    />
                  </label>
                  <label class="block text-xs uppercase tracking-[0.3em] text-slate-500">
                    Root domain
                    <input
                      id="root-domain"
                      type="text"
                      value="<%= panelHost %>"
                      class="mt-1 w-full rounded-xl border border-neutral-800 bg-neutral-950 py-2 px-3 text-sm text-white focus:border-sky-500 focus:outline-none"
                      placeholder="example.com"
                    />
                  </label>
                  <label class="block text-xs uppercase tracking-[0.3em] text-slate-500">
                    Target IP or hostname
                    <input
                      id="target-ip"
                      type="text"
                      value="<%= defaultIp %>"
                      class="mt-1 w-full rounded-xl border border-neutral-800 bg-neutral-950 py-2 px-3 text-sm text-white focus:border-sky-500 focus:outline-none"
                      placeholder="192.168.0.1"
                    />
                  </label>
                  <label class="block text-xs uppercase tracking-[0.3em] text-slate-500">
                    Game port (for SRV)
                    <input
                      id="target-port"
                      type="number"
                      value="<%= defaultPort %>"
                      class="mt-1 w-full rounded-xl border border-neutral-800 bg-neutral-950 py-2 px-3 text-sm text-white focus:border-sky-500 focus:outline-none"
                      placeholder="25565"
                    />
                  </label>
                </div>

                <div class="rounded-2xl bg-neutral-950/70 border border-neutral-800/70 p-4 space-y-3">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-[0.65rem] uppercase tracking-[0.3em] text-slate-500">Preview</p>
                      <p class="text-lg font-semibold text-white" id="subdomain-preview">play.example.com</p>
                    </div>
                    <div class="text-xs text-slate-400">A record + SRV record for Minecraft and most games.</div>
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs font-mono">
                    <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-3">
                      <p class="text-slate-500 mb-1">A record</p>
                      <pre id="a-record-preview" class="text-slate-200 whitespace-pre-wrap">Name: play
Type: A
Target: 0.0.0.0</pre>
                    </div>
                    <div class="rounded-xl bg-neutral-900 border border-neutral-800 p-3">
                      <p class="text-slate-500 mb-1">SRV record</p>
                      <pre id="srv-record-preview" class="text-slate-200 whitespace-pre-wrap">Service: _minecraft._tcp
Name: example.com
Port: 25565
Target: play.example.com</pre>
                    </div>
                  </div>
                </div>

                <div class="flex flex-wrap gap-3">
                  <button
                    type="button"
                    class="inline-flex items-center justify-center rounded-2xl bg-sky-500/90 px-4 py-2 text-sm font-semibold text-white hover:bg-sky-400 transition"
                    data-copy="a"
                  >
                    Copy A record
                  </button>
                  <button
                    type="button"
                    class="inline-flex items-center justify-center rounded-2xl border border-neutral-800/70 bg-neutral-900/70 px-4 py-2 text-sm font-semibold text-slate-200 hover:border-slate-500 transition"
                    data-copy="srv"
                  >
                    Copy SRV record
                  </button>
                  <button
                    type="button"
                    class="inline-flex items-center justify-center rounded-2xl border border-neutral-800/70 bg-white/5 px-4 py-2 text-sm font-semibold text-white hover:bg-white/10 transition"
                    data-copy="cloudflare"
                  >
                    Copy Cloudflare API command
                  </button>
                  <a
                    href="<%= serverBasePath %>/support"
                    class="inline-flex items-center justify-center rounded-2xl border border-sky-500/30 bg-sky-500/10 px-4 py-2 text-sm font-semibold text-sky-200 hover:bg-sky-500/20 transition"
                  >
                    Ask support to provision it
                  </a>
                </div>
              </div>

              <div class="bg-neutral-900/60 border border-neutral-800/80 rounded-2xl p-6 space-y-4">
                <div>
                  <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Pointers</p>
                  <h2 class="text-xl font-semibold text-white mt-1">Safe DNS setup</h2>
                  <p class="text-sm text-slate-400 mt-1">Keep these in mind so your subdomain routes correctly to the panel allocation.</p>
                </div>

                <div class="rounded-2xl bg-neutral-950/70 border border-neutral-800/70 p-4 space-y-2 text-sm text-slate-300">
                  <p class="font-semibold text-white">Match the allocation IP</p>
                  <p class="text-slate-400">Use the IP assigned by the panel to avoid mismatched routing. SRV records let you hide the port.</p>
                </div>
                <div class="rounded-2xl bg-neutral-950/70 border border-neutral-800/70 p-4 space-y-2 text-sm text-slate-300">
                  <p class="font-semibold text-white">Propagate changes</p>
                  <p class="text-slate-400">DNS updates can take up to 10 minutes. Flush DNS or reconnect to test sooner.</p>
                </div>
                <div class="rounded-2xl bg-neutral-950/70 border border-neutral-800/70 p-4 space-y-2 text-sm text-slate-300">
                  <p class="font-semibold text-white">Need staff help?</p>
                  <p class="text-slate-400">Use the support tab to send your desired subdomain, IP, and port. Weâ€™ll add it for you.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
      <%- include('../../components/footer') %>
    </div>
  </div>
  <%- include('../../components/notifications') %>

  <script>
    (() => {
      const prefixInput = document.getElementById("subdomain-prefix");
      const rootInput = document.getElementById("root-domain");
      const ipInput = document.getElementById("target-ip");
      const portInput = document.getElementById("target-port");
      const previewHost = document.getElementById("subdomain-preview");
      const aPreview = document.getElementById("a-record-preview");
      const srvPreview = document.getElementById("srv-record-preview");

      const cloudflareTemplate = () => {
        const host = buildHost();
        return [
          'curl -X POST "https://api.cloudflare.com/client/v4/zones/<ZONE_ID>/dns_records" \\',
          '  -H "Authorization: Bearer <API_TOKEN>" \\',
          '  -H "Content-Type: application/json" \\',
          `  --data '{ "type": "A", "name": "${host}", "content": "${ipInput.value.trim() || "0.0.0.0"}", "ttl": 120 }'`
        ].join("\n");
      };

      function buildHost() {
        const prefix = (prefixInput.value || "").trim();
        const root = (rootInput.value || "").trim();
        return prefix ? `${prefix}.${root || "example.com"}` : (root || "example.com");
      }

      function updatePreviews() {
        const host = buildHost();
        const ip = ipInput.value.trim() || "0.0.0.0";
        const port = portInput.value.trim() || "25565";

        previewHost.textContent = host;
        aPreview.textContent = `Name: ${host}\nType: A\nTTL: 120s\nTarget: ${ip}`;
        srvPreview.textContent = `Service: _minecraft._tcp\nName: ${rootInput.value.trim() || "example.com"}\nPriority: 0  Weight: 5\nPort: ${port}\nTarget: ${host}`;
      }

      function notify(message, type = "info") {
        if (window.showNotification) {
          window.showNotification(message, type);
        } else {
          alert(message);
        }
      }

      async function copyText(value, successMessage) {
        try {
          await navigator.clipboard.writeText(value);
          notify(successMessage, "success");
        } catch (err) {
          notify("Could not copy to clipboard; copy it manually instead.", "warning");
          console.warn("Clipboard copy failed", err);
        }
      }

      [prefixInput, rootInput, ipInput, portInput].forEach((input) => {
        input.addEventListener("input", updatePreviews);
      });

      document.querySelectorAll("[data-copy]").forEach((button) => {
        button.addEventListener("click", () => {
          const intent = button.getAttribute("data-copy");
          if (intent === "a") {
            copyText(aPreview.textContent, "A record copied");
          } else if (intent === "srv") {
            copyText(srvPreview.textContent, "SRV record copied");
          } else if (intent === "cloudflare") {
            copyText(cloudflareTemplate(), "Cloudflare API command copied");
          }
        });
      });

      updatePreviews();
    })();
  </script>
</body>
