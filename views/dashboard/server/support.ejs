<%- include('../../components/head') %>

<body class="min-h-screen bg-neutral-950 text-slate-100">
  <%- include('../../components/modal') %>
  <div>
    <%- include('../../components/navigation') %>
    <div class="md:pl-64 flex flex-col flex-1 min-h-screen">
      <%- include('../../components/header') %>
      <main class="flex-1 pb-8">
        <div class="py-4 md:py-6">
          <%- include('../../components/skeleton') %>
          <div class="hidden max-w-screen-2xl mx-auto px-4 sm:px-6 md:px-8" id="content">
            <%- include('./header') %>
            <%- include('./tabs') %>

            <%
              const alloc = server.relationships && server.relationships.allocations && server.relationships.allocations.data && server.relationships.allocations.data.length
                ? server.relationships.allocations.data[0].attributes
                : null;
              const allocIp = alloc ? (alloc.ip_alias || alloc.ip) : "0.0.0.0";
              const allocPort = alloc ? alloc.port : "25565";
              const discordInvite = settings.website && settings.website.discord ? settings.website.discord : "#";
            %>

            <div class="grid grid-cols-1 xl:grid-cols-[1.6fr_1fr] gap-6 mt-6">
              <div class="bg-neutral-900/60 border border-neutral-800/80 rounded-2xl p-6 space-y-4">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Support</p>
                    <h2 class="text-xl font-semibold text-white mt-1">We’ll help you get unstuck</h2>
                    <p class="text-sm text-slate-400 mt-1">Share the key details for this server and reach staff faster.</p>
                  </div>
                  <div class="rounded-full bg-sky-500/10 border border-sky-500/30 px-3 py-1 text-[0.65rem] font-semibold uppercase tracking-[0.25em] text-sky-300">
                    Avg reply: under 1h
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                  <div class="rounded-2xl bg-neutral-950/70 border border-neutral-800/70 p-4">
                    <p class="text-[0.65rem] uppercase tracking-[0.3em] text-slate-500">Server</p>
                    <p class="text-lg font-semibold text-white"><%= server.attributes.name %></p>
                    <p class="text-xs text-slate-500 mt-1">ID: <%= server.attributes.id %> · Identifier: <%= server.attributes.identifier %></p>
                  </div>
                  <div class="rounded-2xl bg-neutral-950/70 border border-neutral-800/70 p-4">
                    <p class="text-[0.65rem] uppercase tracking-[0.3em] text-slate-500">Primary allocation</p>
                    <p class="text-lg font-semibold text-white"><%= allocIp %>:<%= allocPort %></p>
                    <p class="text-xs text-slate-500 mt-1">Share this with support for connection checks.</p>
                  </div>
                </div>

                <div class="flex flex-wrap gap-3">
                  <a
                    href="/support"
                    class="inline-flex items-center justify-center rounded-2xl bg-sky-500/90 px-4 py-2 text-sm font-semibold text-white hover:bg-sky-400 transition"
                  >
                    Open support center
                  </a>
                  <a
                    href="<%= discordInvite %>"
                    target="_blank"
                    rel="noreferrer"
                    class="inline-flex items-center justify-center rounded-2xl border border-neutral-800/70 bg-neutral-900/70 px-4 py-2 text-sm font-semibold text-slate-200 hover:border-slate-500 transition"
                  >
                    Join Discord
                  </a>
                  <a
                    href="<%= serverBasePath %>/subdomain"
                    class="inline-flex items-center justify-center rounded-2xl border border-neutral-800/70 bg-white/5 px-4 py-2 text-sm font-semibold text-white hover:bg-white/10 transition"
                  >
                    Request a subdomain
                  </a>
                </div>

                <div class="rounded-2xl bg-neutral-950/70 border border-neutral-800/70 p-4 space-y-3">
                  <div class="flex items-center justify-between gap-2">
                    <div>
                      <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Ticket helper</p>
                      <p class="text-sm text-slate-400">Copy this snippet into your ticket to speed up triage.</p>
                    </div>
                    <button
                      type="button"
                      id="copy-ticket-template"
                      class="px-3 py-1 rounded-xl bg-sky-500/80 text-xs font-semibold text-white hover:bg-sky-400 transition"
                    >
                      Copy template
                    </button>
                  </div>
                  <textarea
                    id="ticket-template"
                    class="w-full rounded-xl border border-neutral-800 bg-neutral-900 text-sm text-slate-200 p-3 font-mono"
                    rows="6"
                    readonly
                  ></textarea>
                </div>
              </div>

              <div class="bg-neutral-900/60 border border-neutral-800/80 rounded-2xl p-6 space-y-4">
                <div>
                  <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Checklist</p>
                  <h2 class="text-xl font-semibold text-white mt-1">Common fixes</h2>
                  <p class="text-sm text-slate-400 mt-1">Try these before opening a ticket—they solve most connection issues.</p>
                </div>

                <ul class="space-y-3 text-sm text-slate-300">
                  <li class="rounded-2xl bg-neutral-950/70 border border-neutral-800/70 p-4">
                    <p class="font-semibold text-white">Restart after changes</p>
                    <p class="text-slate-400">Plugin updates, subdomain changes, or config edits usually require a restart.</p>
                  </li>
                  <li class="rounded-2xl bg-neutral-950/70 border border-neutral-800/70 p-4">
                    <p class="font-semibold text-white">Check the latest logs</p>
                    <p class="text-slate-400">Open the console and scroll to the first error—paste it into your ticket.</p>
                  </li>
                  <li class="rounded-2xl bg-neutral-950/70 border border-neutral-800/70 p-4">
                    <p class="font-semibold text-white">Confirm your IP/port</p>
                    <p class="text-slate-400">Match the connection details shown above with your game client settings.</p>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </main>
      <%- include('../../components/footer') %>
    </div>
  </div>
  <%- include('../../components/notifications') %>

  <script>
    (() => {
      const template = document.getElementById("ticket-template");
      const copyBtn = document.getElementById("copy-ticket-template");
      if (!template || !copyBtn) return;

      const details = {
        name: "<%= server.attributes.name %>",
        id: "<%= server.attributes.id %>",
        identifier: "<%= server.attributes.identifier %>",
        ip: "<%= allocIp %>",
        port: "<%= allocPort %>"
      };

      template.value = [
        "Issue summary: (what is broken?)",
        "",
        `Server: ${details.name} (ID: ${details.id}, Identifier: ${details.identifier})`,
        `Primary allocation: ${details.ip}:${details.port}`,
        "What you changed before the issue:",
        "Steps to reproduce:",
        "Last error lines (from console):"
      ].join("\\n");

      function notify(message, type = "info") {
        if (window.showNotification) {
          window.showNotification(message, type);
        } else {
          alert(message);
        }
      }

      copyBtn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(template.value);
          notify("Support template copied", "success");
        } catch (err) {
          notify("Could not copy to clipboard; copy it manually instead.", "warning");
          console.warn("Clipboard copy failed", err);
        }
      });
    })();
  </script>
</body>
